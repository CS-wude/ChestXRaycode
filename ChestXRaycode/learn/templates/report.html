{% extends "base.html" %}

{% block title %}详细分析报告 - 胸部X光片AI分析{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <!-- 报告标题 -->
        <div class="card shadow-lg mb-4">
            <div class="card-header bg-medical-light">
                <div class="d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">
                        <i class="fas fa-file-medical me-2 text-primary"></i>
                        胸部X光片AI分析详细报告
                    </h3>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="window.print()">
                            <i class="fas fa-print me-1"></i>打印
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="downloadReport()">
                            <i class="fas fa-download me-1"></i>下载
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="window.close()">
                            <i class="fas fa-times me-1"></i>关闭
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <p class="mb-1"><strong>报告ID：</strong>{{ report_id }}</p>
                        <p class="mb-1"><strong>生成时间：</strong>{{ report.system_info.analysis_time[:19] if report.system_info else '未知' }}</p>
                        <p class="mb-1"><strong>分析模型：</strong>{{ report.system_info.image_model if report.system_info else 'ResNet50-ChestXRay' }}</p>
                        {% if report.system_info and report.system_info.llm_model %}
                        <p class="mb-0"><strong>语言模型：</strong>{{ report.system_info.llm_model }}</p>
                        {% endif %}
                    </div>
                    <div class="col-md-4 text-end">
                        {% set predicted_class = report.image_analysis.predicted_class if report.image_analysis else '未知' %}
                        {% set confidence = (report.image_analysis.confidence * 100)|round(1) if report.image_analysis else 0 %}
                        {% if predicted_class == 'PNEUMONIA' %}
                            <span class="badge bg-warning fs-6">疑似肺炎</span>
                        {% elif predicted_class == 'NORMAL' %}
                            <span class="badge bg-success fs-6">正常</span>
                        {% else %}
                            <span class="badge bg-secondary fs-6">{{ predicted_class }}</span>
                        {% endif %}
                        <p class="text-muted mt-2 mb-0">置信度: {{ confidence }}%</p>
                    </div>
                </div>
            </div>
        </div>

        {% if report.image_analysis %}
        <!-- 基础分析结果 -->
        <div class="card shadow-lg mb-4">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-chart-pie me-2 text-primary"></i>
                    基础分析结果
                </h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5>分类结果</h5>
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>类别</th>
                                    <th>概率</th>
                                    <th>可视化</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="{% if report.image_analysis.predicted_class == 'NORMAL' %}table-success{% endif %}">
                                    <td>正常 (NORMAL)</td>
                                    <td>{{ (report.image_analysis.probabilities.NORMAL * 100)|round(1) }}%</td>
                                    <td>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar bg-success" 
                                                 style="width: {{ (report.image_analysis.probabilities.NORMAL * 100)|round(1) }}%">
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                <tr class="{% if report.image_analysis.predicted_class == 'PNEUMONIA' %}table-warning{% endif %}">
                                    <td>肺炎 (PNEUMONIA)</td>
                                    <td>{{ (report.image_analysis.probabilities.PNEUMONIA * 100)|round(1) }}%</td>
                                    <td>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar bg-danger" 
                                                 style="width: {{ (report.image_analysis.probabilities.PNEUMONIA * 100)|round(1) }}%">
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="col-md-6">
                        <h5>技术信息</h5>
                        <table class="table table-sm">
                            <tbody>
                                {% if report.image_analysis.image_size %}
                                <tr>
                                    <td><strong>图像尺寸:</strong></td>
                                    <td>{{ report.image_analysis.image_size[0] }} × {{ report.image_analysis.image_size[1] }} 像素</td>
                                </tr>
                                {% endif %}
                                <tr>
                                    <td><strong>预测时间:</strong></td>
                                    <td>{{ report.image_analysis.prediction_time[:19] }}</td>
                                </tr>
                                <tr>
                                    <td><strong>置信度:</strong></td>
                                    <td>{{ (report.image_analysis.confidence * 100)|round(2) }}%</td>
                                </tr>
                                {% if report.system_info %}
                                <tr>
                                    <td><strong>模型版本:</strong></td>
                                    <td>{{ report.system_info.image_model }}</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if report.comprehensive_assessment %}
        <!-- 风险评估 -->
        <div class="card shadow-lg mb-4">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-exclamation-triangle me-2 text-warning"></i>
                    风险评估
                </h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        {% set risk = report.comprehensive_assessment.risk_assessment %}
                        {% set urgency_class = 'danger' if risk.urgency == 'urgent' else ('warning' if risk.urgency == 'moderate' else ('info' if risk.urgency == 'low' else 'secondary')) %}
                        
                        <div class="alert alert-{{ urgency_class }}">
                            <h5><i class="fas fa-flag me-2"></i>{{ risk.level }}</h5>
                            <p class="mb-2">{{ risk.description }}</p>
                            <hr>
                            <p class="mb-0"><strong>建议行动：</strong>{{ risk.recommended_action }}</p>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        {% set confidence_info = report.comprehensive_assessment.confidence_analysis %}
                        <h6>置信度分析</h6>
                        <div class="card bg-light">
                            <div class="card-body">
                                <div class="text-center mb-2">
                                    <span class="badge bg-primary fs-5">{{ (confidence_info.score * 100)|round(1) }}%</span>
                                </div>
                                <p class="small text-center mb-2">{{ confidence_info.reliability }}</p>
                                <p class="small text-muted mb-0">{{ confidence_info.interpretation }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if report.medical_report and not '失败' in report.medical_report and not '不可用' in report.medical_report %}
        <!-- AI医学报告 -->
        <div class="card shadow-lg mb-4">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-robot me-2 text-info"></i>
                    AI生成的医学报告
                </h4>
            </div>
            <div class="card-body">
                <div class="medical-report-content" style="line-height: 1.8; white-space: pre-line;">
                    {{ report.medical_report }}
                </div>
            </div>
        </div>
        {% endif %}

        {% if report.comprehensive_assessment and report.comprehensive_assessment.recommendations %}
        <!-- 详细建议 -->
        <div class="card shadow-lg mb-4">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-lightbulb me-2 text-success"></i>
                    详细建议
                </h4>
            </div>
            <div class="card-body">
                {% set recs = report.comprehensive_assessment.recommendations %}
                
                <div class="row">
                    {% if recs.immediate_actions %}
                    <div class="col-md-6 mb-4">
                        <div class="card border-danger">
                            <div class="card-header bg-danger text-white">
                                <h6 class="mb-0"><i class="fas fa-exclamation me-2"></i>立即行动</h6>
                            </div>
                            <div class="card-body">
                                <ul class="mb-0">
                                    {% for action in recs.immediate_actions %}
                                    <li>{{ action }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if recs.follow_up %}
                    <div class="col-md-6 mb-4">
                        <div class="card border-warning">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0"><i class="fas fa-calendar-check me-2"></i>后续跟进</h6>
                            </div>
                            <div class="card-body">
                                <ul class="mb-0">
                                    {% for action in recs.follow_up %}
                                    <li>{{ action }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if recs.lifestyle %}
                    <div class="col-md-6 mb-4">
                        <div class="card border-info">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0"><i class="fas fa-heart me-2"></i>生活方式建议</h6>
                            </div>
                            <div class="card-body">
                                <ul class="mb-0">
                                    {% for lifestyle in recs.lifestyle %}
                                    <li>{{ lifestyle }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if recs.when_to_seek_help %}
                    <div class="col-md-6 mb-4">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="fas fa-ambulance me-2"></i>何时寻求医疗帮助</h6>
                            </div>
                            <div class="card-body">
                                <ul class="mb-0">
                                    {% for condition in recs.when_to_seek_help %}
                                    <li>{{ condition }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        {% if report.medical_advice %}
        <!-- 基础医学建议 -->
        <div class="card shadow-lg mb-4">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-stethoscope me-2 text-info"></i>
                    医学建议
                </h4>
            </div>
            <div class="card-body">
                {% set advice = report.medical_advice %}
                {% set urgency_class = 'danger' if advice.urgency == 'urgent' else ('warning' if advice.urgency == 'moderate' else ('info' if advice.urgency == 'low' else 'secondary')) %}
                
                <div class="alert alert-{{ urgency_class }}">
                    <h5><i class="fas fa-flag me-2"></i>{{ advice.risk_level }}</h5>
                    <p class="mb-0">{{ advice.recommendation }}</p>
                </div>
                
                <h6 class="mt-4"><i class="fas fa-info-circle me-2"></i>置信度解释</h6>
                <p>{{ advice.confidence_interpretation }}</p>
                
                <h6><i class="fas fa-exclamation-triangle me-2"></i>重要声明</h6>
                <ul>
                    {% for disclaimer in advice.disclaimers %}
                    <li>{{ disclaimer }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}

        {% if report.comprehensive_assessment and report.comprehensive_assessment.disclaimers %}
        <!-- 免责声明 -->
        <div class="card shadow-lg mb-4">
            <div class="card-header bg-warning text-dark">
                <h4 class="mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    重要声明
                </h4>
            </div>
            <div class="card-body">
                <ul class="mb-0">
                    {% for disclaimer in report.comprehensive_assessment.disclaimers %}
                    <li class="mb-2">{{ disclaimer }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}

        <!-- 技术信息 -->
        <div class="card shadow-lg mb-4">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-cogs me-2 text-secondary"></i>
                    技术信息
                </h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>系统信息</h6>
                        <table class="table table-sm">
                            <tbody>
                                {% if report.system_info %}
                                <tr>
                                    <td><strong>分析类型:</strong></td>
                                    <td>{{ '多模态AI' if report.analysis_type == 'multimodal' else '基础分析' }}</td>
                                </tr>
                                <tr>
                                    <td><strong>图像模型:</strong></td>
                                    <td>{{ report.system_info.image_model }}</td>
                                </tr>
                                {% if report.system_info.llm_model and report.system_info.llm_model != 'N/A' %}
                                <tr>
                                    <td><strong>语言模型:</strong></td>
                                    <td>{{ report.system_info.llm_model }}</td>
                                </tr>
                                {% endif %}
                                <tr>
                                    <td><strong>分析时间:</strong></td>
                                    <td>{{ report.system_info.analysis_time[:19] }}</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>报告信息</h6>
                        <table class="table table-sm">
                            <tbody>
                                <tr>
                                    <td><strong>报告ID:</strong></td>
                                    <td>{{ report_id }}</td>
                                </tr>
                                <tr>
                                    <td><strong>版本:</strong></td>
                                    <td>ChestXRay AI v1.0</td>
                                </tr>
                                <tr>
                                    <td><strong>生成时间:</strong></td>
                                    <td>{{ report.system_info.analysis_time[:19] if report.system_info else '未知' }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 操作按钮 -->
        <div class="text-center mb-4">
            <button class="btn btn-primary me-2" onclick="window.print()">
                <i class="fas fa-print me-2"></i>打印报告
            </button>
            <button class="btn btn-success me-2" onclick="downloadReport()">
                <i class="fas fa-download me-2"></i>下载JSON
            </button>
            <button class="btn btn-secondary" onclick="window.close()">
                <i class="fas fa-arrow-left me-2"></i>返回
            </button>
        </div>
    </div>
</div>

<style>
    @media print {
        .navbar, footer, .btn, .no-print { display: none !important; }
        .card { border: 1px solid #dee2e6 !important; box-shadow: none !important; }
        .card-header { background-color: #f8f9fa !important; color: #000 !important; }
        body { background: white !important; }
    }
</style>

<script>
    function downloadReport() {
        window.location.href = `/download/{{ report_id }}`;
    }
</script>
{% endblock %} 